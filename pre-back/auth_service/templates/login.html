<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login y Register</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/estilos.css') }}"
    />
  </head>
  <body>
    <main>
      <div class="contenedor__todo">
        <div class="caja__trasera">
          <div class="caja__trasera-login">
            <h3>¿Ya tienes una cuenta?</h3>
            <p>Inicia sesión para entrar en la página</p>
            <button id="btn__iniciar-sesion">Iniciar Sesión</button>
          </div>
          <div class="caja__trasera-register">
            <h3>¿Aún no tienes una cuenta?</h3>
            <p>Regístrate para que puedas iniciar sesión</p>
            <button id="btn__registrarse">Regístrarse</button>
          </div>
        </div>

        <!--Formulario de Login y registro-->
        <div class="contenedor__login-register">
          <!--Login-->
          <form class="formulario__login" id="formulario__login" onsubmit="login(event)">
            <h2>Iniciar Sesión</h2>
            <input
              type="number"
              placeholder="Cedula"
              name="cedulaLogin"
              id="cedulaLogin"
              required
            />
            <input
              type="password"
              placeholder="Contraseña"
              name="passwordLogin"
              id="passwordLogin"
              required
            />
            <button type="submit">Entrar</button>
          </form>

          <!--Register-->
          <form
            class="formulario__register"
            id="formulario__register"
            onsubmit="register(event)"
            required
          >
            <h2>Regístrarse</h2>
            <input
              type="text"
              placeholder="Nombre completo"
              name="username"
              id="username"
              required
            />
            <input
              type="number"
              placeholder="Cedula"
              name="cedula"
              id="cedula"
              required
            />
            <input
              type="text"
              placeholder="Correo Electronico"
              name="email"
              id="email"
              required
            />
            <input
              type="password"
              placeholder="Contraseña"
              name="password"
              id="password"
              required
            />
            <button type="submit">Regístrarse</button>
          </form>
        </div>
      </div>
    </main>
    <!-- Modal -->
    <div id="responseModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <p id="modalMessage"></p>
      </div>
    </div>
    <!-- fin modal -->
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
      async function login(event) {
        event.preventDefault();
        const form = document.getElementById("formulario__login");
        const formData = new FormData(form);
        const data = {
          cedula: formData.get("cedulaLogin"),
          password: formData.get("passwordLogin"),
        };

        try {
          const response = await fetch("/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          const result = await response.json();
          showModal(result.message);

          if (response.ok) {
            if (result.data.role == "admin") {
              setTimeout(() => {
                window.location.href = `http://127.0.0.1:5002/admin/questions?token=${result.data.token}`; // Redirigir al dashboard
              }, 2000);
              
            } else {
                setTimeout(() => {
                window.location.href = `http://127.0.0.1:5006/user/software?token=${result.data.token}`; // Redirigir al dashboard
              }, 2000);
            }
          }
        } catch (error) {
          showModal("Error en el servidor. Por favor, intenta de nuevo.");
        }
      }
    </script>

    <script>
      async function register(event) {
        event.preventDefault();
        const form = document.getElementById("formulario__register");
        const formData = new FormData(form);
        const data = {
          username: formData.get("username"),
          email: formData.get("email"),
          password: formData.get("password"),
          cedula: formData.get("cedula"),
        };

        try {
          const response = await fetch("/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          const result = await response.json();
          showModal(result.message);

          if (response.ok) {
            setTimeout(() => {
              window.location.href = "/auth/login"; // Redirigir al login
            }, 2000);
          }
        } catch (error) {
          showModal("Error en el servidor. Por favor, intenta de nuevo.");
        }
      }
    </script>
  </body>
</html>
